---
title: "Spline & Mobility"
author: "Yixuan Luo"
date: "4/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(ggplot2)
library(reshape2)
```

Get teaching method data
```{r}
OH_K12 <- read.csv("Processed Data/OH_K12_clean.csv")
OH_K12$opendategrouped <- as.Date(OH_K12$opendategrouped)

# aggregate OH_K12 data by #enrollments in each districts 
# number of students & prop of students by different teaching methods
teachingmethod_enroll <- OH_K12 %>%
  distinct(county,teachingmethod,leaid,district_enroll,county_enroll)%>%
  group_by(county,teachingmethod, county_enroll)%>%
  summarise(total_teachingmethod = sum(district_enroll),prop_teachingmethod = round(sum(district_enroll/county_enroll),2),.groups = "drop")

# reshape the data frame
wide_teaching_enroll <- teachingmethod_enroll%>%
  dcast(county+county_enroll~teachingmethod,value.var ='prop_teachingmethod')
wide_teaching_enroll[is.na(wide_teaching_enroll)] <- 0

# remove unknown,pending, other
wide_teaching_enroll <- wide_teaching_enroll%>%
  select(-Unknown,-Other,-Pending)

# majority teaching method
wide_teaching_enroll[,'major_teaching']<- apply(wide_teaching_enroll[,3:5], 1, function(x){names(which.max(x))})
```

Import data for Splines.
```{r}
cases_clean <- read.csv("county_splines.csv", header = T)
```

```{r}
cases_clean$DATE <- as.Date(cases_clean$DATE)
```

```{r}
# get majority teaching method wide_teaching_enroll
cases_clean_teach <- cases_clean %>%
  left_join(wide_teaching_enroll, by = c("COUNTY" = "county")) %>%
  drop_na(major_teaching)
cases_clean_teach$major_teaching <- factor(cases_clean_teach$major_teaching,
                                           levels = c("On Premises","Hybrid","Online Only"))
```


Import only Work Hours (Mobility) from Delphi
```{r}
mobility_work <- read.csv("mobility_work_clean.csv")
mobility_work$time_value <- as.Date(mobility_work$time_value)
```

```{r}
# get majority teaching method wide_teaching_enroll
mobility_work_teach <- mobility_work %>%
  left_join(wide_teaching_enroll, by = c("COUNTY" = "county")) %>%
  drop_na(major_teaching)
mobility_work_teach$major_teaching <- factor(mobility_work_teach$major_teaching,
                                           levels = c("On Premises","Hybrid","Online Only"))
```

Plot1.1: cumulative mobility per color (plot the 3 curves on the same plot).

Aggregate counties by teaching method

```{r}
mobility_work_teach_agg <- mobility_work_teach %>%
  group_by(time_value, major_teaching) %>%
  summarise(total_work = sum(work_prop_7d), .groups = "drop") %>%
  group_by(major_teaching) 
```

```{r}
ggplot(mobility_work_teach_agg, aes(x = time_value, color = major_teaching)) +
  geom_line(aes(y = total_work), alpha = 1)+ 
  geom_rect(data = mobility_work_teach_agg[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() + 
  labs(x = "Date", y = "Cumulative Mobility (Work Hours)", 
       color = "Majority Teaching Method",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")
ggsave("cum_mobility_time_series.png",width = 7, height = 5)
```

Plot1.2: average mobility per color (plot the 3 curves on the same plot).

```{r}
mobility_work_teach_agg_1 <- mobility_work_teach %>%
  group_by(time_value, major_teaching) %>%
  summarise(avg_work = mean(work_prop_7d), .groups = "drop") %>%
  group_by(major_teaching) 
```

```{r}
ggplot(mobility_work_teach_agg_1, aes(x = time_value, color = major_teaching)) +
  geom_line(aes(y = avg_work), alpha = 1)+ 
  geom_rect(data = mobility_work_teach_agg_1[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() + 
  labs(x = "Date", y = "Average Mobility (Work Hours)", 
       color = "Majority Teaching Method",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")
ggsave("avg_mobility_time_series.png",width = 7, height = 5)
```


\newpage

Then a series of 3 plots, each plot showing the first diff of log death and 

cum mobility for each color. If the 2 curves are parallel, then mobility explains death entirely and school has no effect.

```{r}
#for duaplot()
source("https://gist.githubusercontent.com/ellisp/4002241def4e2b360189e58c3f461b4a/raw/e959562be9e7a4d919a9c454d8b1b70cde904ab0/dualplot.R")
```

Aggregate counties by teaching method (cases_clean)

```{r}
cases_clean_teach_agg <- cases_clean_teach %>%
  group_by(DATE, major_teaching) %>%
  summarise(total_new_deaths = sum(rev_NEWDEATHS), .groups = "drop") %>%
  mutate(log_new_deaths = log(total_new_deaths + 1)) %>%
  group_by(major_teaching) %>%
  mutate(smooth.spline = smooth.spline(DATE,log_new_deaths,df = 398/28)$y,
         B = predict(smooth.spline(DATE,log_new_deaths,df = 398/28),deriv = 1)$y)
```


Plot2.1: On Premises
```{r}
m_op <- mobility_work_teach_agg %>%
  filter(major_teaching == 'On Premises')

c_op <- cases_clean_teach_agg %>%
  filter(major_teaching == 'On Premises')
```

Combine the two datasets

```{r}
op_df <- left_join(m_op, c_op, by = c('time_value' = 'DATE'))
```

```{r}
library(latticeExtra)

# --> construct separate plots for each series
obj1_op <- xyplot(total_work ~ time_value, m_op, type = "l" , lwd=2, xlab = 'Time', ylab = 'Cumulative Mobility (Work Hours)')
obj2_op <- xyplot(B ~ DATE, c_op, type = "l", lwd=2, ylab = "Exponential Growth Coefficient")
 
# --> Make the plot with second y axis:
doubleYScale(obj1_op, obj2_op, text = c("Cumulative Mobility (Work Hours)", "Exponential Growth Coefficient"), add.ylab2 = TRUE, title = "Time Series of Teaching Method - On Premises")
```


Combine the two datasets

```{r}
op_df <- left_join(m_op, c_op, by = c('time_value' = 'DATE'))
```

```{r}
temperatureColor <- "#69b3a2"
priceColor <- rgb(0.2, 0.6, 0.9, 1)

op_df %>% ggplot(aes(x=time_value)) +
  geom_line( aes(y=total_work), alpha = 1, color=temperatureColor) + 
  geom_line( aes(y=B/0.1), alpha = 1, color=priceColor) +
  scale_y_continuous(
    # Features of the first axis
    name = "Cumulative Mobility (Work Hours)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*0.1, name="Exponential Growth Coefficient")
  ) +
  geom_rect(data = mobility_work_teach_agg_1[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() +
  theme(
    axis.title.y = element_text(color = temperatureColor, size=13),
    axis.title.y.right = element_text(color = priceColor, size=13)
  ) + labs(x = 'Date', subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  ggtitle("Time Series of Teaching Method - On Premises")

ggsave("time_series_on_premises.png",width = 7, height = 5)
```


Plot2.2: Hybrid
```{r}
m_hy <- mobility_work_teach_agg %>%
  filter(major_teaching == 'Hybrid')

c_hy <- cases_clean_teach_agg %>%
  filter(major_teaching == 'Hybrid')

# --> construct separate plots for each series
obj1_hy <- xyplot(total_work ~ time_value, m_hy, type = "l" , lwd=2, xlab = 'Time', ylab = 'Cumulative Mobility (Work Hours)')
obj2_hy <- xyplot(B ~ DATE, c_hy, type = "l", lwd=2, ylab = "Exponential Growth Coefficient")
 
# --> Make the plot with second y axis:
doubleYScale(obj1_hy, obj2_hy, text = c("Cumulative Mobility (Work Hours)", "Exponential Growth Coefficient"), add.ylab2 = TRUE, title = "Time Series of Teaching Method - Hybrid")
```


Combine the two datasets

```{r}
hy_df <- left_join(m_hy, c_hy, by = c('time_value' = 'DATE'))

temperatureColor <- "#69b3a2"
priceColor <- rgb(0.2, 0.6, 0.9, 1)

hy_df %>% ggplot(aes(x=time_value)) +
  geom_line( aes(y=total_work), alpha = 1, color=temperatureColor) + 
  geom_line( aes(y=B/0.1), alpha = 1, color=priceColor) +
  scale_y_continuous(
    # Features of the first axis
    name = "Cumulative Mobility (Work Hours)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*0.1, name="Exponential Growth Coefficient")
  ) +
  geom_rect(data = mobility_work_teach_agg_1[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() +
  theme(
    axis.title.y = element_text(color = temperatureColor, size=13),
    axis.title.y.right = element_text(color = priceColor, size=13)
  ) + labs(x = 'Date', subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  ggtitle("Time Series of Teaching Method - Hybrid")

ggsave("time_series_hybrid.png",width = 7, height = 5)
```

Plot2.3: Online Only
```{r}
m_on <- mobility_work_teach_agg %>%
  filter(major_teaching == 'Online Only')

c_on <- cases_clean_teach_agg %>%
  filter(major_teaching == 'Online Only')

# --> construct separate plots for each series
obj1_on <- xyplot(total_work ~ time_value, m_on, type = "l" , lwd=2, xlab = 'Time', ylab = 'Cumulative Mobility (Work Hours)')
obj2_on <- xyplot(B ~ DATE, c_on, type = "l", lwd=2, ylab = "Exponential Growth Coefficient")
 
# --> Make the plot with second y axis:
doubleYScale(obj1_on, obj2_on, text = c("Cumulative Mobility (Work Hours)", "Exponential Growth Coefficient"), add.ylab2 = TRUE, title = "Time Series of Teaching Method - Online Only")
```


Combine the two datasets

```{r}
on_df <- left_join(m_on, c_on, by = c('time_value' = 'DATE'))

temperatureColor <- "#69b3a2"
priceColor <- rgb(0.2, 0.6, 0.9, 1)

on_df %>% ggplot(aes(x=time_value)) +
  geom_line( aes(y=total_work), alpha = 1, color=temperatureColor) + 
  geom_line( aes(y=B/0.1), alpha = 1, color=priceColor) +
  scale_y_continuous(
    # Features of the first axis
    name = "Cumulative Mobility (Work Hours)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*0.1, name="Exponential Growth Coefficient")
  ) +
  geom_rect(data = mobility_work_teach_agg_1[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() +
  theme(
    axis.title.y = element_text(color = temperatureColor, size=13),
    axis.title.y.right = element_text(color = priceColor, size=13)
  ) + labs(x = 'Date', subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  ggtitle("Time Series of Teaching Method - Online Only")

ggsave("time_series_online_only.png",width = 7, height = 5)
```

\newpage

B against mobility by teaching method.

```{r}
op_df%>%
  ggplot(aes(x = total_work, y = B)) + 
  geom_point(na.rm = TRUE,aes(colour = 'salmon')) + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Mobility (Work Hours)", y = "Exponential Growth Coefficient", 
       title = "Cumulative Mobility (Work Hours) ~ Exponential Growth Coefficient for On Premises")+theme(text = element_text(size=14),title = element_text(size=16))
ggsave("lm_on_premises.jpg", width = 15, height = 6)
```

```{r}
hy_df%>%
  ggplot(aes(x = total_work, y = B)) + 
  geom_point(na.rm = TRUE,aes(colour = 'salmon')) + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Mobility (Work Hours)", y = "Exponential Growth Coefficient", 
       title = "Cumulative Mobility (Work Hours) ~ Exponential Growth Coefficient for Hybrid")+theme(text = element_text(size=14),title = element_text(size=16))
ggsave("lm_hybrid.jpg", width = 15, height = 6)
```

```{r}
on_df%>%
  ggplot(aes(x = total_work, y = B)) + 
  geom_point(na.rm = TRUE,aes(colour = 'salmon')) + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Mobility (Work Hours)", y = "Exponential Growth Coefficient", 
       title = "Cumulative Mobility (Work Hours) ~ Exponential Growth Coefficient for Online Only")+theme(text = element_text(size=14),title = element_text(size=16))
ggsave("lm_online.jpg", width = 15, height = 6)
```




