---
title: "Slopes of the time series"
author: "Cheyenne, Ziyan"
date: "4/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load in the spline slopes

```{r message=FALSE, warning=FALSE, cache=TRUE}
source("step2_data_wrangle.r")

# read in cases data 
# negative values of NEWDEATHS redistributed in rev_NEWDEATHS var
# splines and slopes added
cases_slope <- read.csv("county_splines.csv", header = T)%>%
  select(COUNTY,DATE,POPULATION,CUMDEATHS,log_tot_deaths,tot.slope,NEWDEATHS,rev_NEWDEATHS,log_new_deaths,new.slope)

cases_slope$DATE <- as.Date(cases_slope$DATE)

# get majority teaching method wide_teaching_enroll
cases_slope_teach <-death_teaching%>%
  select(-DATE,-POPULATION,-CUMDEATHS,-NEWDEATHS)%>%
  distinct()%>%
  right_join(cases_slope,by=c("COUNTY"))

write.csv(cases_slope_teach,"cases_slope_teach.csv",row.names = F)

## ordering the teaching method factor to ensure the color order
cases_slope_teach$major_teaching <- factor(cases_slope_teach$major_teaching,levels = c("On Premises","Hybrid","Online Only"))
cases_slope_teach$DATE <- as.Date(cases_slope_teach$DATE)
```

# Select Max B1 & B0

```{r}
maxB1 <- cases_slope_teach%>%
  group_by(COUNTY)%>%
  filter(DATE >= as.Date("2020-08-18") & DATE<=as.Date("2020-12-15"))%>%
  summarise(max_B1 = max(new.slope))

avgB1 <- cases_slope_teach%>%
  group_by(COUNTY)%>%
  filter(DATE >= as.Date("2020-08-18") & DATE<=as.Date("2020-12-15"))%>%
  summarise(avg_B1 = mean(new.slope))

## avg3w_B0 ## average B0 of the first 3 weeks of school reopening 
## avg1w_2w_B0 ## OR average B0s between  2020-08-18 -7days and +14days [before the rate bounce back around the dashed line]
## avg3w_bf_B0 ## OR average B0s between  2020-08-18 -21days and 2020-08-18 [before the rate bounce back around the dashed line]

avgB0 <- cases_slope_teach%>%
  group_by(COUNTY)%>%
  filter(DATE > as.Date("2020-08-18") & DATE<as.Date(major_opendate)+21)%>%
  summarise(avg3w_B0 = mean(new.slope))%>%
  left_join(cases_slope_teach%>%
  group_by(COUNTY)%>%
  filter(DATE > as.Date("2020-08-18")-7 & DATE<as.Date("2020-08-18")+14)%>%
  summarise(avg1w_2w_B0 = mean(new.slope)),by="COUNTY")%>%
  left_join(cases_slope_teach%>%
  group_by(COUNTY)%>%
  filter(DATE < as.Date("2020-08-18") & DATE>=as.Date("2020-08-18")-21)%>%
  summarise(avg3w_bf_B0 = mean(new.slope)),by="COUNTY")
```


# Aggregate counties by teaching method

```{r}
cases_slope_teach_agg <- cases_slope_teach %>%
  drop_na(major_teaching)%>%
  group_by(DATE, major_teaching) %>%
  summarise(total_new_deaths = sum(rev_NEWDEATHS), .groups = "drop") %>%
  mutate(log_new_deaths = log(total_new_deaths + 1)) %>%
  group_by(major_teaching) %>%
  mutate(smooth.spline = smooth.spline(DATE,log_new_deaths,df = 398/28)$y,
         B = predict(smooth.spline(DATE,log_new_deaths,df = 398/28),deriv = 1)$y)

ggplot(cases_slope_teach_agg, aes(x = DATE, color = major_teaching)) +
  geom_point(aes(y = log_new_deaths), alpha = .3)+ 
  geom_line(aes(y = smooth.spline), size = 1) +
  geom_rect(data = cases_slope_teach_agg[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() + 
  labs(x = "Date", y = "Log ( New Deaths + 1 )", 
       color = "Majority Teaching Method",
       caption = "Smoothing window set to every 4 weeks",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank())+
  theme(axis.text = element_text(size=15),axis.title=element_text(size=15),legend.text = element_text(size=13))
#ggsave("log_death_time_series.png",width = 7, height = 5)

week3_after_start <- as.Date("2020/08/18") + 21

ggplot(cases_slope_teach_agg, aes(x = DATE, color = major_teaching)) + 
  geom_line(aes(y = B), size = 1) +
  geom_rect(data = cases_slope_teach_agg[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") +
  geom_vline(xintercept = week3_after_start, lty = 2) + 
  annotate("text",label = week3_after_start,
           x = week3_after_start, y = .05, hjust = 1.1)+ 
  labs(x = "Date", y = "Exponential Growth Coefficient", 
       color = "Majority Teaching Method",
       caption = "Smoothing window set to every 4 weeks",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank())+
  theme(axis.text = element_text(size=15),axis.title=element_text(size=15),legend.text = element_text(size=13))
#ggsave("egc_time_series.png",width = 7, height = 5)
```


```{r}
# average full time work mobility in 6 weeks window
avg_mobility <- case_mobility%>%
  left_join(major_reopening,by=c("COUNTY"))%>%
  group_by(COUNTY)%>%
  filter(DATE >= as.Date(major_opendate) + 21 & DATE <= as.Date(major_opendate) + 63)%>%
  summarise(avg_full_work_prob = mean(full_work_prop_7d))

# made major teaching method prop
wide_teaching_enroll <- wide_teaching_enroll%>%
  mutate(major_teaching_prop = case_when(
    major_teaching=="Online Only" ~ Online_Only,
    major_teaching=="Hybrid" ~ Hybrid,
    major_teaching=="On Premises" ~On_Premises,
    TRUE~ 0
  ))

#  B0 and B1
B0B1 <- maxB1%>%
  left_join(wide_teaching_enroll, by = c("COUNTY" = "county"))%>%
  left_join(avgB1,by="COUNTY")%>%
  left_join(avgB0,by="COUNTY")%>%
  left_join(avg_mobility,by="COUNTY")
## ordering the teaching method factor to ensure the color order
B0B1$major_teaching <- factor(B0B1$major_teaching,levels = c("On Premises","Hybrid","Online Only"))
```


```{r}
team_theme <- theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "bottom",legend.box="vertical", legend.margin=margin())+theme(legend.text = element_text(size=12),legend.title = element_text(size=12),axis.text = element_text(size=13),title=element_text(size=13))
```


```{r  message=FALSE, warning=FALSE}
# max B1 vs B0
B0B1%>%
  ggplot(aes(x=avg3w_B0,y=max_B1,group=major_teaching,color=major_teaching))+geom_point(aes(size=avg_full_work_prob,alpha=major_teaching_prop))+theme_minimal()+labs(color="Majority Teaching Method",size="Averaged \n%6hr+ Away Home",title="max B1 v.s. averaged B0 in 3 weeks after reopen",alpha="Size of Majority",y="Max B1", x= "Averaged B0 in 3 weeks")+geom_smooth(method = "lm", se=F, formula = y ~ x,alpha=0.1)+geom_vline(xintercept = 0, lty = 2)+team_theme
ggsave("maxB1vsAvgB0.png",width = 7, height = 7)

# avgB1 vs avg3w_B0
B0B1%>%
  ggplot(aes(x=avg3w_B0,y=avg_B1,group=major_teaching,color=major_teaching))+geom_point(aes(size=avg_full_work_prob,alpha=major_teaching_prop))+geom_smooth(method = "lm", se=F, formula = y ~ x,alpha=0.1)+theme_minimal()+labs(color="Majority Teaching Method",size="Averaged \n%6hr+ Away Home",title="Averaged B1 in Fall v.s. averaged B0 in 3 weeks after reopen",alpha="Size of Majority",y="Averaged B1 in Fall", x= "Averaged B0 in 3 weeks")+
  team_theme+team_theme+geom_vline(xintercept = 0, lty = 2)
ggsave("avgB1vsAvgB0.png",width = 7, height = 7)

```

```{r}
# avgB1 vs avg1w_2w_B0
B0B1%>%
  ggplot(aes(x=avg1w_2w_B0,y=max_B1,group=major_teaching,color=major_teaching))+geom_point(aes(size=avg_full_work_prob,alpha=major_teaching_prop))+geom_smooth(method = "lm", se=F, formula = y ~ x,alpha=0.1)+theme_minimal()+labs(color="Majority Teaching Method",size="Averaged \n%6hr+ Away Home",title="Max B1 in Fall v.s.\n averaged B0 between 1 week before and 2 weeks after reopen",alpha="Size of Majority",y="Max B1 in Fall", x= "Averaged B0 in 3 weeks")+
  team_theme+team_theme+geom_vline(xintercept = 0, lty = 2)
ggsave("maxB1vsAvgB01w2w.png",width = 7, height = 7)

# avgB1 vs avg1w_2w_B0
B0B1%>%
  ggplot(aes(x=avg1w_2w_B0,y=avg_B1,group=major_teaching,color=major_teaching))+geom_point(aes(size=avg_full_work_prob,alpha=major_teaching_prop))+geom_smooth(method = "lm", se=F, formula = y ~ x,alpha=0.1)+theme_minimal()+labs(color="Majority Teaching Method",size="Averaged \n%6hr+ Away Home",title="Averaged B1 in Fall v.s.\n averaged B0 1 week before and 2 weeks after reopen",alpha="Size of Majority",y="Averaged B1 in Fall", x= "Averaged B0 in 3 weeks")+
  team_theme+team_theme+geom_vline(xintercept = 0, lty = 2)
ggsave("avgB1vsAvgB01w2w.png",width = 7, height = 7)
```

# Mobility

Plot1.1: cumulative mobility per color (plot the 3 curves on the same plot).

Aggregate counties by teaching method

```{r}
cum_mobility <- wide_teaching_enroll%>%
  left_join(case_mobility,by=c("county"="COUNTY"))%>%
  left_join(major_opendate,by="county")%>%
  group_by(DATE,major_teaching)%>%
  summarise(cum_full_work = sum(full_work_prop_7d*POPULATION),cum_full_work_prop = sum(full_work_prop_7d*POPULATION)/sum(POPULATION), .groups = "drop")%>%
  mutate(shiftedDate = DATE+28) ## Shifted Dates!!!!!!!!!!!!

cum_mobility$major_teaching <- factor(cum_mobility$major_teaching,levels = c("On Premises","Hybrid","Online Only"))

```

```{r}
options(scipen=1000)

ggplot(cum_mobility, aes(x = shiftedDate, color = major_teaching)) +
  geom_line(aes(y = cum_full_work), alpha = 1,size=1)+ 
  geom_rect(data = cum_mobility[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() + 
  labs(x = "Date", y = "Cumulative Full-time Workers/Students", 
       color = "Majority Teaching Method", title="Cumulative Full-time Mobility (6hrs+ Away Home)\n4 Weeks Forward",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "bottom")+theme(legend.text = element_text(size=12),legend.title = element_text(size=12),axis.text = element_text(size=13),title=element_text(size=13))

#ggsave("cum_mobility_time_series.png",width = 7, height = 5)
```

Plot1.2: average mobility per color (plot the 3 curves on the same plot).

```{r}
date.intercept=as.Date("2020-11-24")

date_mobility$major_teaching <- factor(date_mobility$major_teaching,levels = c("On Premises","Hybrid","Online Only"))

date_mobility$shiftedDate <- date_mobility$DATE + 28

# FULL TIME WORK, 6 hours +
date_mobility%>%
  ggplot(aes(x=shiftedDate,y=full_work_prop))+
  geom_rect(data=date_mobility[1,],
            aes(xmin=as.Date("2020/08/26"), xmax=as.Date("2020/12/12"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  geom_line(aes(color = major_teaching),size = 1, alpha = .8)+
  geom_vline(xintercept = date.intercept, linetype = "dashed") + 
  annotate("text",x = date.intercept,y = 0.08,
           label = date.intercept,
           hjust = 1.1,size=5) + 
  theme_bw() + 
  labs(x = "Date", y = "% Full-time Workers/Students",subtitle = "Average over 7 days; Yellow area represents Fall Semester",
       color = "Majority Teaching Method",title = "Average %Cell Phones Away Home for 6hr+\n4 Weeks Forward") + ylim(0.02,0.10)+
  theme(legend.position = "bottom")+theme(legend.title = element_text(size=13),legend.text = element_text(size=13),axis.title = element_text(size=15),axis.text = element_text(size=15),legend.background = element_rect(fill = alpha("orange",0.0)),legend.key.size = unit(1.4,"lines"),title = element_text(size=12.9))+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 

```

\newpage

Then a series of 3 plots, each plot showing the first diff of log death and 

cum mobility for each color. If the 2 curves are parallel, then mobility explains death entirely and school has no effect.

Aggregate counties by teaching method (cases_clean)

Plot2.1: On Premises

```{r}
cases_clean_teach_agg%>%
  filter(major_teaching=="On Premises")%>%
  inner_join(cum_mobility%>%filter(major_teaching=="On Premises"),by=c("DATE"="shiftedDate"))%>%
  ggplot(aes(x = DATE))+
  geom_line(aes(y = B),size = 1,color="red") +
  geom_rect(data = cases_clean_teach_agg[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + theme_bw() + 
  labs(x = "Date", y = "Exponential Growth Coefficient", title="On-Premises Counties\n Mobility 4 weeks forward",
       color = "Majority Teaching Method",
       caption = "Smoothing window set to every 4 weeks",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")+
  geom_line(aes(x = DATE,y=cum_full_work/1000000),color="orange")+
  scale_y_continuous(,# Add a second axis and specify its features
  sec.axis = sec_axis(trans=~.,name="Cumulative Full-time Workers/Students",labels =c("-1"," ","0","25k","50k","75k")))+annotate("text",label="Exponential Growth Coefficient",x=as.Date("2020-09-21"),y=-0.010)+annotate("text",label="Cumulative Full-time Workers/Students",x=as.Date("2020-06-21"),y=0.040)+
  theme(legend.title = element_text(size=13),legend.text = element_text(size=12),axis.title = element_text(size=12),axis.text = element_text(size=12),title = element_text(size=12.9))+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 
ggsave("time_series_on_premises.png",width = 7, height = 5)
```

```{r}
cases_clean_teach_agg%>%
  filter(major_teaching=="On Premises")%>%
  inner_join(cum_mobility%>%filter(major_teaching=="On Premises"),by=c("DATE"="shiftedDate"))%>%
  ggplot(aes(y = B,x=cum_full_work))+ 
  geom_point(na.rm = TRUE,colour = 'salmon') + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Full-time Workers/Students", y = "Exponential Growth Coefficient", 
       title = "B ~ Cumulative Full-time Workers/Students 4 weeks forward\n On Premises")+theme(text = element_text(size=14),title = element_text(size=13))

ggsave("lm_on_premises.jpg", width = 15, height = 6)
```


Plot2.2: Hybrid
```{r}
cases_clean_teach_agg%>%
  filter(major_teaching=="Hybrid")%>%
  inner_join(cum_mobility%>%filter(major_teaching=="Hybrid"),by=c("DATE"="shiftedDate"))%>%
  ggplot(aes(x = DATE))+
  geom_line(aes(y = B),size = 1,color="darkgreen") +
  geom_rect(data = cases_clean_teach_agg[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + theme_bw() + 
  labs(x = "Date", y = "Exponential Growth Coefficient", title="Hybrid Counties\n Mobility 4 weeks forward",
       color = "Majority Teaching Method",
       caption = "Smoothing window set to every 4 weeks",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")+
  geom_line(aes(x = DATE,y=cum_full_work/1000000),color="green")+
  scale_y_continuous(# Add a second axis and specify its features
  sec.axis = sec_axis(trans=~.*10,name="Cumulative Full-time Workers/Students",labels = c(" "," ","0","200k","300k","400k","500k")))+
  annotate("text",label="Exponential Growth Coefficient",x=as.Date("2020-09-21"),y=0.06)+
  annotate("text",label="Cumulative Full-time Workers/Students",x=as.Date("2020-06-21"),y=0.40)+
  theme(legend.title = element_text(size=13),legend.text = element_text(size=12),axis.title = element_text(size=12),axis.text = element_text(size=12),title = element_text(size=12.9))+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 

#ggsave("time_series_hybrid.png",width = 7, height = 5)
```
```{r}
cases_clean_teach_agg%>%
  filter(major_teaching=="Hybrid")%>%
  inner_join(cum_mobility%>%filter(major_teaching=="Hybrid"),by=c("DATE"="shiftedDate"))%>%
  ggplot(aes(y = B,x=cum_full_work))+ 
  geom_point(na.rm = TRUE,colour = 'darkgreen') + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Full-time Workers/Students", y = "Exponential Growth Coefficient", 
       title = "B ~ Cumulative Full-time Workers/Students 4 weeks forward\n Hybrid")+theme(text = element_text(size=14),title = element_text(size=13))
  
```

Plot2.3: Online Only
```{r}
cases_clean_teach_agg%>%
  filter(major_teaching=="Online Only")%>%
  inner_join(cum_mobility%>%filter(major_teaching=="Online Only"),by=c("DATE"="shiftedDate"))%>%
  ggplot(aes(x = DATE))+
  geom_line(aes(y = B),size = 1,color="darkblue") +
  geom_rect(data = cases_clean_teach_agg[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + theme_bw() + 
  labs(x = "Date", y = "Exponential Growth Coefficient", title="Online-only Counties\n Mobility 4 weeks forward",
       color = "Majority Teaching Method",
       caption = "Smoothing window set to every 4 weeks",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")+
  geom_line(aes(x = DATE,y=cum_full_work/1000000),color="blue")+
  scale_y_continuous(# Add a second axis and specify its features
  sec.axis = sec_axis(trans=~.*10,name="Cumulative Full-time Workers/Students",labels = c(" ","0","100k","200k","300k","400k")))+
  annotate("text",label="Exponential Growth Coefficient",x=as.Date("2020-09-21"),y=0.06)+
  annotate("text",label="Cumulative Full-time Workers/Students",x=as.Date("2020-06-21"),y=0.40)+
  theme(legend.title = element_text(size=13),legend.text = element_text(size=12),axis.title = element_text(size=12),axis.text = element_text(size=12),title = element_text(size=12.9))+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 

ggsave("time_series_online_only.png",width = 7, height = 5)
```


```{r}
cases_clean_teach_agg%>%
  filter(major_teaching=="Online Only")%>%
  inner_join(cum_mobility%>%filter(major_teaching=="Online Only"),by=c("DATE"="shiftedDate"))%>%
  ggplot(aes(y = B,x=cum_full_work))+ 
  geom_point(na.rm = TRUE,colour = 'darkblue') + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Full-time Workers/Students", y = "Exponential Growth Coefficient", 
       title = "B ~ Cumulative Full-time Workers/Students 4 weeks forward\n Online Only")+theme(text = element_text(size=14),title = element_text(size=13))
  
```
