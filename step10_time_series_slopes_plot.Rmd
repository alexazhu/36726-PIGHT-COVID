---
title: "Slopes of the time series"
author: "Cheyenne, Ziyan"
date: "4/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data

```{r message=FALSE, warning=FALSE, cache=TRUE}
source("step2_data_wrangle.r")

# read in cases data 
# negative values of NEWDEATHS redistributed in rev_NEWDEATHS var
# splines and slopes added
cases_clean <- read.csv("county_splines.csv", header = T)
cases_clean$DATE <- as.Date(cases_clean$DATE)

# get majority teaching method wide_teaching_enroll
cases_clean_teach <- cases_clean %>%
  left_join(wide_teaching_enroll, by = c("COUNTY" = "county")) %>%
  drop_na(major_teaching)%>%
  left_join(county_open_teaching_enroll%>%
  group_by(county)%>%
  slice(which.max(opendate_teaching_county_prop)),by=c("COUNTY" = "county"))
  
cases_clean_teach$major_teaching <- factor(cases_clean_teach$major_teaching,levels = c("On Premises","Hybrid","Online Only"))

```



## Histogram of B0 and B1 in 3 weeks

```{r fig.height=3, fig.width=3, message=FALSE, warning=FALSE}
library(gridExtra)

## B0 week3_after_start
b03 <- cases_clean_teach%>%
  group_by(COUNTY)%>%
  filter(DATE == as.Date(opendate) + 21)%>%
  ggplot(aes(x=tot.slope,fill=major_teaching))+geom_histogram(stat = "bin",binwidth = 0.005,color="white")+facet_wrap(~major_teaching)+theme(legend.text = element_text(size=13),legend.title = element_text(size=14))+labs(fill="Major Teaching",x="Slopes of Total Deaths",title="B0 at 3 weeks after school reopen")+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "")

## B1 week4_after
b14 <- cases_clean_teach%>%
  group_by(COUNTY)%>%
  filter(DATE == as.Date(opendate) + 49)%>%
  ggplot(aes(x=tot.slope,fill=major_teaching))+geom_histogram(stat = "bin",binwidth = 0.005,color="white")+facet_wrap(~major_teaching)+theme(legend.text = element_text(size=13),legend.title = element_text(size=14))+labs(fill="Major Teaching",x="Slopes of Total Deaths",title="B1 at 7(3+4) weeks after school reopen")+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "")

## B1 week6_after
b16 <- cases_clean_teach%>%
  group_by(COUNTY)%>%
  filter(DATE == as.Date(opendate) + 63)%>%
  ggplot(aes(x=tot.slope,fill=major_teaching))+geom_histogram(stat = "bin",binwidth = 0.005,color="white")+facet_wrap(~major_teaching)+theme(legend.text = element_text(size=13),legend.title = element_text(size=14))+labs(fill="Major Teaching",x="Slopes of Total Deaths",title="B1 at 9(3+6) weeks after school reopen")+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "")

grid.arrange(b03,b14,b16)
```


# Aggregate counties by teaching method

```{r}
cases_clean_teach_agg <- cases_clean_teach %>%
  group_by(DATE, major_teaching) %>%
  summarise(total_new_deaths = sum(rev_NEWDEATHS), .groups = "drop") %>%
  mutate(log_new_deaths = log(total_new_deaths + 1)) %>%
  group_by(major_teaching) %>%
  mutate(smooth.spline = smooth.spline(DATE,log_new_deaths,df = 398/28)$y,
         B = predict(smooth.spline(DATE,log_new_deaths,df = 398/28),deriv = 1)$y)

ggplot(cases_clean_teach_agg, aes(x = DATE, color = major_teaching)) +
  geom_point(aes(y = log_new_deaths), alpha = .3)+ 
  geom_line(aes(y = smooth.spline), size = 1) +
  geom_rect(data = cases_clean_teach_agg[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() + 
  labs(x = "Date", y = "Log ( New Deaths + 1 )", 
       color = "Majority Teaching Method",
       caption = "Smoothing window set to every 4 weeks",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")
#ggsave("log_death_time_series.png",width = 7, height = 5)

week3_after_start <- as.Date("2020/08/18") + 21

ggplot(cases_clean_teach_agg, aes(x = DATE, color = major_teaching)) + 
  geom_line(aes(y = B), size = 1) +
  geom_rect(data = cases_clean_teach_agg[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") +
  geom_vline(xintercept = week3_after_start, lty = 2) + 
  annotate("text",label = week3_after_start,
           x = week3_after_start, y = .05, hjust = 1.1)+ 
  theme_bw() + 
  labs(x = "Date", y = "Exponential Growth Coefficient", 
       color = "Majority Teaching Method",
       caption = "Smoothing window set to every 4 weeks",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(legend.position = "bottom")
#ggsave("egc_time_series.png",width = 7, height = 5)
```


```{r}
# average full time work mobility in 6 weeks window
avg_mobility <- case_mobility%>%
  left_join(county_open_teaching_enroll%>%
  group_by(county)%>%
  slice(which.max(opendate_teaching_county_prop)),by=c("COUNTY" = "county"))%>%
  group_by(COUNTY)%>%
  filter(DATE >= as.Date(opendate) + 21 & DATE <= as.Date(opendate) + 63)%>%
  summarise(avg_full_work_prob = mean(full_work_prop_7d))


# slice single date B0 and B1
B0B1 <- cases_clean_teach%>%
  group_by(COUNTY)%>%
  filter(DATE == as.Date(opendate) + 21|DATE == as.Date(opendate) + 63 )%>%arrange(COUNTY,DATE)%>%mutate(B_label=ifelse(row_number()==1,"B0","B1"))%>%
  left_join(avg_mobility,by="COUNTY")
  
```


```{r}
B0B1_mobility <- B0B1%>%
  dcast(COUNTY+major_teaching+avg_full_work_prob~B_label,value.var="tot.slope")

# B0 vs B1
B0B1_mobility%>%
  ggplot(aes(x=B0,y=B1,group=major_teaching,color=major_teaching))+geom_point(alpha=0.7,aes(size=avg_full_work_prob))+theme_minimal()+labs(color="Major Teaching",size="Average \n%6hr+ Away Home",title="B1 at 9(3+6) weeks after reopen v.s. B0 at 3 weeks after reopen")+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "right")+geom_smooth(method = "lm", se=T, formula = y ~ x,alpha=0.1)+theme(legend.text = element_text(size=12),legend.title = element_text(size=12),axis.text = element_text(size=13),title=element_text(size=13))

# B1-B0 vs B1
B0B1_mobility%>%
  mutate(B1diffB0 = B1-B0)%>%
  ggplot(aes(x=B0,y=B1diffB0,group=major_teaching,color=major_teaching))+geom_point(alpha=0.7,aes(size=avg_full_work_prob))+geom_smooth(method = "lm", se=T, formula = y ~ x,alpha=0.1)+theme_minimal()+labs(y="B1-B0",color="Major Teaching",size="Average \n%6hr+ Away Home",title="B1-B0 v.s. B0",subtitle = "B1 at 9(3+6) weeks after reopen, B0 at 3 weeks after reopen")+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "right")+theme(legend.text = element_text(size=12),legend.title = element_text(size=12),axis.text = element_text(size=13),title=element_text(size=13))

```


# Mobility

Plot1.1: cumulative mobility per color (plot the 3 curves on the same plot).

Aggregate counties by teaching method

```{r}
major_opendate <- county_open_teaching_enroll%>%
  group_by(county)%>%
  slice(which.max(opendate_teaching_county_prop))%>%select(county,opendate)

cum_mobility <- wide_teaching_enroll%>%
  left_join(case_mobility,by=c("county"="COUNTY"))%>%
  left_join(major_opendate,by="county")%>%
  group_by(DATE,major_teaching)%>%
  summarise(cum_full_work = sum(full_work_prop_7d*POPULATION),cum_full_work_prop = sum(full_work_prop_7d*POPULATION)/sum(POPULATION), .groups = "drop")
```

```{r}
options(scipen=1000)
ggplot(cum_mobility, aes(x = DATE, color = major_teaching)) +
  geom_line(aes(y = cum_full_work), alpha = 1,size=1)+ 
  geom_rect(data = cum_mobility[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() + 
  labs(x = "Date", y = "Cumulative Full-time Workers/Students", 
       color = "Majority Teaching Method", title="Cumulative Full-time Mobility (6hrs+ Away Home)",
       subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "bottom")+theme(legend.text = element_text(size=12),legend.title = element_text(size=12),axis.text = element_text(size=13),title=element_text(size=13))

ggsave("cum_mobility_time_series.png",width = 7, height = 5)
```

Plot1.2: average mobility per color (plot the 3 curves on the same plot).

```{r}
date.intercept=as.Date("2020-11-24")
# FULL TIME WORK, 6 hours +
date_mobility%>%
  ggplot(aes(x=DATE,y=full_work_prop))+
  geom_rect(data=date_mobility[1,],
            aes(xmin=as.Date("2020/08/26"), xmax=as.Date("2020/12/12"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  geom_line(aes(color = major_teaching),size = 1, alpha = .8)+
  geom_vline(xintercept = date.intercept, linetype = "dashed") + 
  annotate("text",x = date.intercept,y = 0.08,
           label = date.intercept,
           hjust = 1.1,size=5) + 
  theme_bw() + 
  labs(x = "Date", y = "% Full-time Workers/Students",subtitle = "Average over 7 days; Yellow area represents Fall Semester",
       color = "Majority Teaching Method",title = "Average %Cell Phones Away Home for 6hr+") + ylim(0.02,0.10)+
  theme(legend.position = "bottom")+theme(legend.title = element_text(size=13),legend.text = element_text(size=13),axis.title = element_text(size=15),axis.text = element_text(size=15),legend.background = element_rect(fill = alpha("orange",0.0)),legend.key.size = unit(1.4,"lines"),title = element_text(size=12.9))+
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 

```

\newpage

Then a series of 3 plots, each plot showing the first diff of log death and 

cum mobility for each color. If the 2 curves are parallel, then mobility explains death entirely and school has no effect.

```{r}
#for duaplot()
source("https://gist.githubusercontent.com/ellisp/4002241def4e2b360189e58c3f461b4a/raw/e959562be9e7a4d919a9c454d8b1b70cde904ab0/dualplot.R")
```

Aggregate counties by teaching method (cases_clean)

```{r}
cases_clean_teach_agg <- cases_clean_teach %>%
  group_by(DATE, major_teaching) %>%
  summarise(total_new_deaths = sum(rev_NEWDEATHS), .groups = "drop") %>%
  mutate(log_new_deaths = log(total_new_deaths + 1)) %>%
  group_by(major_teaching) %>%
  mutate(smooth.spline = smooth.spline(DATE,log_new_deaths,df = 398/28)$y,
         B = predict(smooth.spline(DATE,log_new_deaths,df = 398/28),deriv = 1)$y)
```


Plot2.1: On Premises
```{r}
m_op <- mobility_work_teach_agg %>%
  filter(major_teaching == 'On Premises')

c_op <- cases_clean_teach_agg %>%
  filter(major_teaching == 'On Premises')
```

Combine the two datasets

```{r}
op_df <- left_join(m_op, c_op, by = c('time_value' = 'DATE'))
```

```{r}
library(latticeExtra)

# --> construct separate plots for each series
obj1_op <- xyplot(total_work ~ time_value, m_op, type = "l" , lwd=2, xlab = 'Time', ylab = 'Cumulative Mobility (Work Hours)')
obj2_op <- xyplot(B ~ DATE, c_op, type = "l", lwd=2, ylab = "Exponential Growth Coefficient")
 
# --> Make the plot with second y axis:
doubleYScale(obj1_op, obj2_op, text = c("Cumulative Mobility (Work Hours)", "Exponential Growth Coefficient"), add.ylab2 = TRUE, title = "Time Series of Teaching Method - On Premises")
```


Combine the two datasets

```{r}
op_df <- left_join(m_op, c_op, by = c('time_value' = 'DATE'))
```

```{r}
temperatureColor <- "#69b3a2"
priceColor <- rgb(0.2, 0.6, 0.9, 1)

op_df %>% ggplot(aes(x=time_value)) +
  geom_line( aes(y=total_work), alpha = 1, color=temperatureColor) + 
  geom_line( aes(y=B/0.1), alpha = 1, color=priceColor) +
  scale_y_continuous(
    # Features of the first axis
    name = "Cumulative Mobility (Work Hours)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*0.1, name="Exponential Growth Coefficient")
  ) +
  geom_rect(data = mobility_work_teach_agg_1[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() +
  theme(
    axis.title.y = element_text(color = temperatureColor, size=13),
    axis.title.y.right = element_text(color = priceColor, size=13)
  ) + labs(x = 'Date', subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  ggtitle("Time Series of Teaching Method - On Premises")

ggsave("time_series_on_premises.png",width = 7, height = 5)
```


Plot2.2: Hybrid
```{r}
m_hy <- mobility_work_teach_agg %>%
  filter(major_teaching == 'Hybrid')

c_hy <- cases_clean_teach_agg %>%
  filter(major_teaching == 'Hybrid')

# --> construct separate plots for each series
obj1_hy <- xyplot(total_work ~ time_value, m_hy, type = "l" , lwd=2, xlab = 'Time', ylab = 'Cumulative Mobility (Work Hours)')
obj2_hy <- xyplot(B ~ DATE, c_hy, type = "l", lwd=2, ylab = "Exponential Growth Coefficient")
 
# --> Make the plot with second y axis:
doubleYScale(obj1_hy, obj2_hy, text = c("Cumulative Mobility (Work Hours)", "Exponential Growth Coefficient"), add.ylab2 = TRUE, title = "Time Series of Teaching Method - Hybrid")
```


Combine the two datasets

```{r}
hy_df <- left_join(m_hy, c_hy, by = c('time_value' = 'DATE'))

temperatureColor <- "#69b3a2"
priceColor <- rgb(0.2, 0.6, 0.9, 1)

hy_df %>% ggplot(aes(x=time_value)) +
  geom_line( aes(y=total_work), alpha = 1, color=temperatureColor) + 
  geom_line( aes(y=B/0.1), alpha = 1, color=priceColor) +
  scale_y_continuous(
    # Features of the first axis
    name = "Cumulative Mobility (Work Hours)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*0.1, name="Exponential Growth Coefficient")
  ) +
  geom_rect(data = mobility_work_teach_agg_1[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() +
  theme(
    axis.title.y = element_text(color = temperatureColor, size=13),
    axis.title.y.right = element_text(color = priceColor, size=13)
  ) + labs(x = 'Date', subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  ggtitle("Time Series of Teaching Method - Hybrid")

ggsave("time_series_hybrid.png",width = 7, height = 5)
```

Plot2.3: Online Only
```{r}
m_on <- mobility_work_teach_agg %>%
  filter(major_teaching == 'Online Only')

c_on <- cases_clean_teach_agg %>%
  filter(major_teaching == 'Online Only')

# --> construct separate plots for each series
obj1_on <- xyplot(total_work ~ time_value, m_on, type = "l" , lwd=2, xlab = 'Time', ylab = 'Cumulative Mobility (Work Hours)')
obj2_on <- xyplot(B ~ DATE, c_on, type = "l", lwd=2, ylab = "Exponential Growth Coefficient")
 
# --> Make the plot with second y axis:
doubleYScale(obj1_on, obj2_on, text = c("Cumulative Mobility (Work Hours)", "Exponential Growth Coefficient"), add.ylab2 = TRUE, title = "Time Series of Teaching Method - Online Only")
```


Combine the two datasets

```{r}
on_df <- left_join(m_on, c_on, by = c('time_value' = 'DATE'))

temperatureColor <- "#69b3a2"
priceColor <- rgb(0.2, 0.6, 0.9, 1)

on_df %>% ggplot(aes(x=time_value)) +
  geom_line( aes(y=total_work), alpha = 1, color=temperatureColor) + 
  geom_line( aes(y=B/0.1), alpha = 1, color=priceColor) +
  scale_y_continuous(
    # Features of the first axis
    name = "Cumulative Mobility (Work Hours)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*0.1, name="Exponential Growth Coefficient")
  ) +
  geom_rect(data = mobility_work_teach_agg_1[1,],
            aes(xmin=as.Date("2020/08/18"), xmax=as.Date("2020/12/15"),
                ymin=-Inf,ymax=Inf),
            color = NA,alpha=0.2, show.legend = F, fill = "orange") + 
  theme_bw() +
  theme(
    axis.title.y = element_text(color = temperatureColor, size=13),
    axis.title.y.right = element_text(color = priceColor, size=13)
  ) + labs(x = 'Date', subtitle = "Yellow area represents the fall semester (08/18 - 12/15)") + 
  ggtitle("Time Series of Teaching Method - Online Only")

ggsave("time_series_online_only.png",width = 7, height = 5)
```

\newpage

B against mobility by teaching method.

```{r}
op_df%>%
  ggplot(aes(x = total_work, y = B)) + 
  geom_point(na.rm = TRUE,aes(colour = 'salmon')) + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Mobility (Work Hours)", y = "Exponential Growth Coefficient", 
       title = "Cumulative Mobility (Work Hours) ~ Exponential Growth Coefficient for On Premises")+theme(text = element_text(size=14),title = element_text(size=16))
ggsave("lm_on_premises.jpg", width = 15, height = 6)
```

```{r}
hy_df%>%
  ggplot(aes(x = total_work, y = B)) + 
  geom_point(na.rm = TRUE,aes(colour = 'salmon')) + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Mobility (Work Hours)", y = "Exponential Growth Coefficient", 
       title = "Cumulative Mobility (Work Hours) ~ Exponential Growth Coefficient for Hybrid")+theme(text = element_text(size=14),title = element_text(size=16))
ggsave("lm_hybrid.jpg", width = 15, height = 6)
```

```{r}
on_df%>%
  ggplot(aes(x = total_work, y = B)) + 
  geom_point(na.rm = TRUE,aes(colour = 'salmon')) + 
  geom_smooth(method = "lm", formula = y~x, se = FALSE, na.rm = TRUE, show.legend = FALSE,colour = 'black') + 
  theme_minimal() + theme(legend.position = "bottom")+
  labs(x = "Cumulative Mobility (Work Hours)", y = "Exponential Growth Coefficient", 
       title = "Cumulative Mobility (Work Hours) ~ Exponential Growth Coefficient for Online Only")+theme(text = element_text(size=14),title = element_text(size=16))
ggsave("lm_online.jpg", width = 15, height = 6)
```



