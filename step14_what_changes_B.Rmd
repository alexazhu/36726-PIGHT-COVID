---
title: "B1 minus B0"
author: "Ziyan Zhu"
date: "4/24/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Notes:

The 1st derivative of log new deaths+1 we observed on date T corresponds to the death growth rate B happend on date T-24.

The mobility date has been shifted one week forward as well. Assuming mobility a week before date T change the infections on date T


# Load in the spline slopes

```{r message=FALSE, warning=FALSE, cache=TRUE}
source("step2_data_wrangle.r") ## B(t) include in step2 as well

## plot theme
team_theme <- theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),legend.position = "bottom",legend.box="vertical", legend.margin=margin())+theme(legend.text = element_text(size=12),legend.title = element_text(size=12),axis.text = element_text(size=13),title=element_text(size=13))
```

# compute the differences in B(3weeks after start) and B(6weeks after start)

```{r}
B3w <- cases_slope_teach%>%
  filter(DATE==as.Date("2020-08-18")+21)%>%
  drop_na(major_teaching)%>%
  rename(new.slope3w=new.slope)

B6w <- cases_slope_teach%>%
  filter(DATE==as.Date("2020-08-18")+42)%>%
  drop_na(major_teaching)%>%
  rename(new.slope6w=new.slope)


avg_mobi_3w <- case_mobility%>%
  left_join(major_reopening,by=c("COUNTY"))%>%
  group_by(COUNTY)%>%
  filter(DATE >= as.Date(major_opendate) + 21 & DATE <= as.Date(major_opendate) + 42)%>%
  summarise(avg3w_full_work_prob = mean(full_work_prop_7d))
colnames(B6w)

B_diff <- B6w[,c(1:9,13,20)]%>%
  left_join(B3w%>%select(COUNTY,new.slope3w),by="COUNTY")%>%
  mutate(new.slope.diff = new.slope6w-new.slope3w)%>%
  left_join(avg_mobi_3w,by="COUNTY")

hist(B_diff$new.slope.diff)
```


```{r}
B_diff%>%
  drop_na(major_teaching)%>%
  ggplot(aes(x=log(Population.density),y=new.slope.diff,group=major_teaching,color=major_teaching))+geom_point(aes(size=avg3w_full_work_prob,alpha=avg3w_full_work_prob))+geom_smooth(method = "lm", se=F, formula = y ~ x,alpha=0.1)+theme_minimal()+team_theme+team_theme+labs(y="Max B1",x="Log of Population",title="B1-B0 vs Log of Population Density",color="Majority Teaching Method",size = "3w~6w\nAveraged %6hr+ Away Home",alpha= "3w~6w\nAveraged %6hr+ Away Home" )
```

```{r}
B_diff%>%
  drop_na(major_teaching)%>%
  ggplot(aes(x=avg3w_full_work_prob,y=new.slope.diff,group=major_teaching,color=major_teaching))+geom_point(aes(size=log(Population.density),alpha=log(Population.density)))+geom_smooth(method = "lm", se=F, formula = y ~ x,alpha=0.1)+theme_minimal()+team_theme+labs(y="Max B1",x="Average mobility proportion during fall semester",title="B1-B0 vs Average full mobility proportion in 3w~6w\n Averaged %6hr+ Away Home",size="Log of Population Density",alpha="Log of Population Density",fill="Majority Teaching Method")

```

```{r}
B_diff%>%
  drop_na(major_teaching)%>%
  ggplot(aes(y=NCHS.Urban.Rural.Status,x=new.slope.diff,fill=NCHS.Urban.Rural.Status))+geom_boxplot()+team_theme+theme(legend.position = "")+labs(x="B(6w) - B(3w)",y="Rural-urban Status",title="Distribution of B(6 weeks after) minus B(3 weeks after)")+
  scale_fill_brewer(palette = "Reds",direction = -1)

B_diff%>%
  drop_na(major_teaching)%>%
  ggplot(aes(y=Metropolitan.Status,x=new.slope.diff,fill=Metropolitan.Status))+geom_boxplot()+team_theme+theme(legend.position = "")+labs(x="B(6w) - B(3w)",y="Metropolitan Status",title="Distribution of B(6 weeks after) minus B(3 weeks after)")+
  scale_fill_brewer(palette = "Reds",direction = -1)  
```

## Redo the plots but only with Micro counties

```{r}
## Filter only the micro counties
B_diff_micro <- B_diff%>%
  drop_na(major_teaching)%>%
  filter(NCHS.Urban.Rural.Status=="Micropolitan")

B_diff_micro%>%
  ggplot(aes(x=log(Population.density),y=new.slope.diff,group=major_teaching,color=major_teaching))+geom_point(aes(size=avg3w_full_work_prob,alpha=avg3w_full_work_prob))+geom_smooth(method = "lm", se=F, formula = y ~ x,alpha=0.1)+theme_minimal()+team_theme+team_theme+labs(y="Max B1",x="Log of Population",title="B1-B0 vs Log of Population Density\nOnly Micropolitan Counties",color="Majority Teaching Method",size = "3w~6w\nAveraged %6hr+ Away Home",alpha= "3w~6w\nAveraged %6hr+ Away Home" )



B_diff_micro%>%
  ggplot(aes(x=avg3w_full_work_prob,y=new.slope.diff,group=major_teaching,color=major_teaching))+geom_point(aes(size=log(Population.density),alpha=log(Population.density)))+geom_smooth(method = "lm", se=F, formula = y ~ x,alpha=0.1)+theme_minimal()+team_theme+labs(y="Max B1",x="Average mobility proportion during fall semester",title="B1-B0 vs Average full mobility proportion in 3w~6w\n Averaged %6hr+ Away Home\nOnly Micropolitan Counties",size="Log of Population Density",alpha="Log of Population Density",fill="Majority Teaching Method")

```



